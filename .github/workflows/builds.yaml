name: ALE Psych Builds

on:
  push:
  workflow_dispatch:

jobs:
  build:
    name: Build ${{ matrix.platform }}
    permissions: write-all
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        include:
          - platform: Windows
            os: windows-latest
            build_cmd: haxelib run lime build windows
            setup_libs: ./install-haxelibs.bat
            extra_libs:
            pre_build_commands:
            post_build_commands:
            artifact_path: export/release/windows/bin

          - platform: Windows x32
            os: windows-latest
            build_cmd: haxelib run lime build windows -32 -D 32bits -D HXCPP_M32
            setup_libs: ./install-haxelibs.bat
            extra_libs:
            pre_build_commands:
            post_build_commands:
            artifact_path: export/32bit/windows/bin

          - platform: Linux
            os: ubuntu-22.04
            build_cmd: haxelib run lime build linux
            setup_libs: sh ./install-haxelibs.sh
            extra_libs: |
              sudo apt-get update
              sudo apt-get install -y libvlc-dev libvlccore-dev dpkg-dev file
            pre_build_commands:
            post_build_commands: |
              set -euo pipefail
              APP_DIR="export/release/linux/bin"
              [ -d "$APP_DIR" ] || { echo "Missing build output dir: $APP_DIR" >&2; exit 1; }
              DEB_ROOT="dist/deb"
              VERSION="4.0.0+ci${{ github.run_id }}"
              DEB_NAME="ale-psych_${VERSION}_amd64.deb"
              ELF_CANDIDATES=()
              OTHER_CANDIDATES=()
              pick_largest() {
                local best=""
                local best_size=0
                local f size
                for f in "$@"; do
                  size=$(stat -c %s "$f")
                  if [ "$size" -gt "$best_size" ]; then
                    best="$f"
                    best_size="$size"
                  fi
                done
                printf '%s' "$best"
              }
              while IFS= read -r -d '' f; do
                if file -b "$f" | grep -q "ELF"; then
                  ELF_CANDIDATES+=("$f")
                else
                  OTHER_CANDIDATES+=("$f")
                fi
              done < <(find "$APP_DIR" -maxdepth 1 -type f -executable ! -name "*.so*" -print0)
              EXE_PATH=$(pick_largest "${ELF_CANDIDATES[@]}")
              if [ -z "$EXE_PATH" ]; then
                EXE_PATH=$(pick_largest "${OTHER_CANDIDATES[@]}")
              fi
              if [ -z "$EXE_PATH" ]; then
                echo "Error: No executable found in $APP_DIR" >&2
                ls -la "$APP_DIR"
                exit 1
              fi
              EXE_NAME=$(basename "$EXE_PATH")
              mkdir -p dist
              rm -rf "$DEB_ROOT"
              mkdir -p "$DEB_ROOT/DEBIAN" "$DEB_ROOT/opt/ale-psych" "$DEB_ROOT/usr/bin" "$DEB_ROOT/usr/share/applications" "$DEB_ROOT/usr/share/metainfo"
              cp -a "$APP_DIR/." "$DEB_ROOT/opt/ale-psych/"
              cat <<'EOF' > "$DEB_ROOT/usr/bin/ale-psych"
              #!/usr/bin/env sh
              BASE="/opt/ale-psych"
              USER_BASE="${XDG_DATA_HOME:-$HOME/.local/share}/ale-psych"
              RUNTIME="$USER_BASE/runtime"
              VERSION_FILE="$USER_BASE/runtime.version"
              VERSION="__VERSION__"
              mkdir -p "$USER_BASE/mods" "$USER_BASE/assets"
              if [ ! -d "$RUNTIME" ] || [ ! -f "$VERSION_FILE" ] || [ "$(cat "$VERSION_FILE" 2>/dev/null || true)" != "$VERSION" ]; then
                rm -rf "$RUNTIME"
                cp -a "$BASE/." "$RUNTIME/"
                printf '%s' "$VERSION" > "$VERSION_FILE"
              fi
              if [ -z "$(ls -A "$USER_BASE/mods" 2>/dev/null)" ] && [ -d "$BASE/mods" ]; then
                cp -a "$BASE/mods/." "$USER_BASE/mods/"
              fi
              if [ -z "$(ls -A "$USER_BASE/assets" 2>/dev/null)" ] && [ -d "$BASE/assets" ]; then
                cp -a "$BASE/assets/." "$USER_BASE/assets/"
              fi
              rm -rf "$RUNTIME/mods"
              ln -s "$USER_BASE/mods" "$RUNTIME/mods"
              rm -rf "$RUNTIME/assets"
              ln -s "$USER_BASE/assets" "$RUNTIME/assets"
              cd "$RUNTIME" || exit 1
              exec "./__EXE_NAME__" "$@"
              EOF
              sed -i "s|__VERSION__|$VERSION|g" "$DEB_ROOT/usr/bin/ale-psych"
              sed -i "s|__EXE_NAME__|$EXE_NAME|g" "$DEB_ROOT/usr/bin/ale-psych"
              chmod 0755 "$DEB_ROOT/usr/bin/ale-psych"
              cat <<'EOF' > "$DEB_ROOT/usr/share/metainfo/ale-psych.metainfo.xml"
              <?xml version="1.0" encoding="UTF-8"?>
              <component type="desktop-application">
                <id>ale-psych.desktop</id>
                <name>ALE Psych</name>
                <summary>Friday Night Funkin' ALE Psych</summary>
                <metadata_license>CC0-1.0</metadata_license>
                <project_license>Proprietary</project_license>
                <url type="homepage">https://alepsych.gamer.gd/</url>
                <description>
                  <p>Friday Night Funkin' ALE Psych mod and engine.</p>
                </description>
              </component>
              EOF
              cat <<'EOF' > "$DEB_ROOT/usr/share/applications/ale-psych.desktop"
              [Desktop Entry]
              Type=Application
              Name=ALE Psych
              Exec=ale-psych
              Icon=ale-psych
              Terminal=false
              Categories=Game;
              EOF
              for icon in \
                usr/share/icons/hicolor/16x16/apps/alepsych.png \
                usr/share/icons/hicolor/24x24/apps/alepsych.png \
                usr/share/icons/hicolor/32x32/apps/alepsych.png \
                usr/share/icons/hicolor/48x48/apps/alepsych.png \
                usr/share/icons/hicolor/64x64/apps/alepsych.png \
                usr/share/icons/hicolor/128x128/apps/alepsych.png \
                usr/share/icons/hicolor/256x256/apps/alepsych.png \
                usr/share/icons/hicolor/512x512/apps/alepsych.png; do
                if [ -f "$icon" ]; then
                  dest_dir="$DEB_ROOT/$(dirname "$icon")"
                  mkdir -p "$dest_dir"
                  cp "$icon" "$dest_dir/ale-psych.png"
                fi
              done
              cat <<EOF > "$DEB_ROOT/DEBIAN/control"
              Package: ale-psych
              Version: $VERSION
              Section: games
              Priority: optional
              Architecture: amd64
              Maintainer: ALE Psych Crew
              Homepage: https://alepsych.gamer.gd/
              Description: Friday Night Funkin' ALE Psych
              EOF
              dpkg-deb --build --root-owner-group "$DEB_ROOT" "dist/$DEB_NAME"
            artifact_path: export/release/linux/bin
            
          - platform: MacOS
            os: macos-15
            build_cmd: haxelib run lime build macos --app-version="4.0.0-${{ github.run_id}}"
            setup_libs: sh ./install-haxelibs.sh
            pre_build_commands:
            post_build_commands:
            artifact_path: export/release/macos/bin
            
          - platform: MacOS x64
            os: macos-15-intel
            build_cmd: haxelib run lime build macos --app-version="4.0.0-${{ github.run_id}}"
            setup_libs: sh ./install-haxelibs.sh
            pre_build_commands:
            post_build_commands:
            artifact_path: export/release/macos/bin
            
    steps:
      - name: Pull the New Commit
        uses: actions/checkout@v4.1.7

      - name: Setup Haxe
        uses: krdlab/setup-haxe@master
        with:
          haxe-version: 4.3.7

      - name: Install Extra Libraries
        if: ${{ matrix.extra_libs }}
        run: ${{ matrix.extra_libs }}

      - name: Install Main Libraries
        run: ${{ matrix.setup_libs }}

      - name: Pre-Build Commands
        if: ${{ matrix.pre_build_commands }}
        run: ${{ matrix.pre_build_commands }}

      - name: Build for ${{ matrix.platform }}
        run: ${{ matrix.build_cmd }}

      - name: Post-Build Commands
        if: ${{ matrix.post_build_commands }}
        shell: bash
        run: ${{ matrix.post_build_commands }}

      - name: Upload Game
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform }} Build
          path: ${{ matrix.artifact_path }}
          if-no-files-found: error

      - name: Upload Linux .deb
        if: ${{ matrix.platform == 'Linux' }}
        uses: actions/upload-artifact@v4
        with:
          name: Linux .deb
          path: dist/*.deb
          if-no-files-found: error
